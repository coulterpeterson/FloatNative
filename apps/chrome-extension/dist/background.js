(()=>{"use strict";var e=function(e,t,n,o){return new(n||(n=Promise))(function(s,i){function r(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,c)}a((o=o.apply(e,t||[])).next())})};const t="https://auth.floatplane.com",n="wasserflug",o=`${t}/realms/floatplane/protocol/openid-connect/token`,s="fp_access_token",i="fp_refresh_token",r="fp_expires_at";class c{constructor(){}static getInstance(){return c.instance||(c.instance=new c),c.instance}startDeviceAuth(){return e(this,void 0,void 0,function*(){const e=new URLSearchParams({client_id:n,scope:"openid offline_access"}),o=yield fetch(`${t}/realms/floatplane/protocol/openid-connect/auth/device`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()});if(!o.ok)throw new Error(`Device Auth Init Failed: ${o.status}`);const s=yield o.json();return{deviceCode:s.device_code,userCode:s.user_code,verificationUri:s.verification_uri,expiresIn:s.expires_in,interval:s.interval}})}pollDeviceToken(t){return e(this,void 0,void 0,function*(){const e=new URLSearchParams({grant_type:"urn:ietf:params:oauth:grant-type:device_code",client_id:n,device_code:t}),s=yield fetch(o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()}),i=yield s.json();return s.ok?(yield this.handleTokenResponse(i),i):i})}getAccessToken(){return e(this,void 0,void 0,function*(){const e=yield chrome.storage.local.get([s,r,i]),t=e[s],n=e[r],o=e[i];if(!t)return null;if(!n||Date.now()>n){if(!o)return yield this.logout(),null;try{return yield this.refreshAccessToken(o),(yield chrome.storage.local.get([s]))[s]}catch(e){return console.error("Refresh failed",e),yield this.logout(),null}}return t})}refreshAccessToken(t){return e(this,void 0,void 0,function*(){const e=new URLSearchParams({grant_type:"refresh_token",client_id:n,refresh_token:t}),s=yield fetch(o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e.toString()});if(!s.ok)throw new Error(`Token Refresh Failed: ${s.status}`);const i=yield s.json();yield this.handleTokenResponse(i)})}handleTokenResponse(t){return e(this,void 0,void 0,function*(){const e=t.access_token,n=t.expires_in,o=t.refresh_token,c=Date.now()+1e3*n;yield chrome.storage.local.set({[s]:e,[r]:c,[i]:o})})}logout(){return e(this,void 0,void 0,function*(){yield chrome.storage.local.remove([s,r,i])})}}var a=function(e,t,n,o){return new(n||(n=Promise))(function(s,i){function r(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,c)}a((o=o.apply(e,t||[])).next())})};const l="https://api.floatnative.coulterpeterson.com",d="fp_companion_key";class u{constructor(){this.apiKey=null,chrome.storage.local.get([d],e=>{e&&e[d]&&(this.apiKey=e[d])})}static getInstance(){return u.instance||(u.instance=new u),u.instance}setApiKey(e){return a(this,void 0,void 0,function*(){this.apiKey=e,yield chrome.storage.local.set({[d]:e})})}request(e){return a(this,arguments,void 0,function*(e,t="GET",n=null,o=!0){const s=`${l}${e}`,i={"Content-Type":"application/json","User-Agent":"FloatNative/1.0 (ChromeExtension)"};o&&(this.apiKey||(yield this.ensureLoggedIn()),this.apiKey&&(i.Authorization=`Bearer ${this.apiKey}`));const r={method:t,headers:i,body:n?JSON.stringify(n):null};let c=yield fetch(s,r);if(401===c.status&&o&&(console.log("CompanionAPI: 401 Unauthorized, re-logging in..."),yield this.ensureLoggedIn(),this.apiKey)){i.Authorization=`Bearer ${this.apiKey}`;const e={method:t,headers:i,body:n?JSON.stringify(n):null};c=yield fetch(s,e)}if(!c.ok){const e=yield c.text();throw new Error(`Companion API Error ${c.status}: ${e}`)}const a=c.headers.get("content-type");return a&&-1!==a.indexOf("application/json")?yield c.json():null})}ensureLoggedIn(){return a(this,void 0,void 0,function*(){console.log("CompanionAPI: ensuring logged in...");const e=c.getInstance();let t=yield e.getAccessToken();if(!t)throw new Error("UserNotAuthenticated");const n=yield this.performCompanionLogin(t);if(!n.api_key)throw new Error("Login response missing api_key");yield this.setApiKey(n.api_key)})}performCompanionLogin(e){return a(this,void 0,void 0,function*(){const t=`${l}/auth/login`,n={access_token:e};console.log("CompanionAPI: Performing login exchange with payload",n);const o=yield fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!o.ok){const e=yield o.text();throw console.error(`CompanionAPI: Login Failed ${o.status}: ${e}`),new Error(`Companion Login Failed: ${o.status} - ${e}`)}return yield o.json()})}getPlaylists(){return a(this,arguments,void 0,function*(e=!1){const t=yield this.request(`/playlists?include_watch_later=${e}`);return console.log("CompanionAPI: getPlaylists response",t),t.playlists})}addToPlaylist(e,t){return a(this,void 0,void 0,function*(){return console.log("CompanionAPI: addToPlaylist",e,t),yield this.request(`/playlists/${e}/add`,"PATCH",{video_id:t})})}removeFromPlaylist(e,t){return a(this,void 0,void 0,function*(){return yield this.request(`/playlists/${e}/remove`,"PATCH",{video_id:t})})}createPlaylist(e){return a(this,void 0,void 0,function*(){return yield this.request("/playlists","POST",{name:e})})}}var h=function(e,t,n,o){return new(n||(n=Promise))(function(s,i){function r(e){try{a(o.next(e))}catch(e){i(e)}}function c(e){try{a(o.throw(e))}catch(e){i(e)}}function a(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(r,c)}a((o=o.apply(e,t||[])).next())})};class p{constructor(){this.baseUrl="https://www.floatplane.com"}static getInstance(){return this.instance||(this.instance=new p),this.instance}getPostDetails(e){return h(this,void 0,void 0,function*(){console.log(`FloatplaneAPI: getPostDetails checking ${e.length} videos`,e);const t=[];for(let n=0;n<e.length;n+=5){const o=e.slice(n,n+5);console.log(`FloatplaneAPI: Fetching chunk ${n/5+1}/${Math.ceil(e.length/5)}`,o);const s=o.map(e=>this.fetchPost(e).catch(t=>(console.error(`FloatplaneAPI: Failed to fetch post ${e}`,t),null)));(yield Promise.all(s)).forEach(e=>{e&&t.push(e)})}return console.log(`FloatplaneAPI: getPostDetails completed. Got ${t.length} posts.`),t})}fetchPost(e){return h(this,void 0,void 0,function*(){const t=yield c.getInstance().getAccessToken();if(!t)throw new Error("Not authenticated");const n=yield fetch(`${this.baseUrl}/api/v3/content/post?id=${e}`,{headers:{Authorization:`Bearer ${t}`}});if(!n.ok)throw new Error(`Error fetching post ${e}: ${n.status} ${n.statusText}`);const o=yield n.json();return o.post?o.post:o})}}console.log("Floatplane Extension Background Worker Loaded"),chrome.runtime.onInstalled.addListener(()=>{console.log("Extension installed")}),chrome.runtime.onMessage.addListener((e,t,n)=>{if(console.log("Background received message:",e),"START_DEVICE_AUTH"===e.type)return c.getInstance().startDeviceAuth().then(e=>n({success:!0,data:e})).catch(e=>n({success:!1,error:e.toString()})),!0;if("POLL_DEVICE_TOKEN"===e.type){const{deviceCode:t}=e;return c.getInstance().pollDeviceToken(t).then(e=>{e.access_token&&u.getInstance().ensureLoggedIn().catch(console.error),n({success:!0,data:e})}).catch(e=>n({success:!1,error:e.toString()})),!0}if("GET_PLAYLISTS"===e.type){const{includeWatchLater:t}=e;return u.getInstance().getPlaylists(t).then(e=>n({success:!0,playlists:e})),!0}if("GET_PLAYLIST_VIDEOS"===e.type){const{videoIds:t}=e;return p.getInstance().getPostDetails(t).then(e=>n({success:!0,posts:e})).catch(e=>n({success:!1,error:e.toString()})),!0}if("ADD_TO_PLAYLIST"===e.type){const{playlistId:t,videoId:o}=e;return u.getInstance().addToPlaylist(t,o).then(e=>n({success:!0,result:e})).catch(e=>n({success:!1,error:e.toString()})),!0}if("REMOVE_FROM_PLAYLIST"===e.type){const{playlistId:t,videoId:o}=e;return u.getInstance().removeFromPlaylist(t,o).then(e=>n({success:!0,result:e})).catch(e=>n({success:!1,error:e.toString()})),!0}if("CREATE_PLAYLIST"===e.type){const{name:t}=e;return u.getInstance().createPlaylist(t).then(e=>n({success:!0,result:e})).catch(e=>n({success:!1,error:e.toString()})),!0}})})();