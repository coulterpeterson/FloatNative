name = "floatnative-api"
main = "src/index.ts"
compatibility_date = "2024-11-21"
compatibility_flags = ["nodejs_compat"]

# Build configuration
[build]

# D1 Database binding
[[d1_databases]]
binding = "DB"
database_name = "floatnative-db"
database_id = "a8bb3620-254d-4502-a18b-463a16927740"

# Environment variables
[vars]
FLOATPLANE_API_URL = "https://www.floatplane.com/api/v3"
API_BASE_URL = "api.floatnative.coulterpeterson.com"
MAILGUN_DOMAIN = "coulterpeterson.com"
NODE_ENV = "production"

# Local development configuration
[env.dev]
[env.dev.vars]
FLOATPLANE_API_URL = "https://www.floatplane.com/api/v3"
API_BASE_URL = "http://localhost:8787"
NODE_ENV = "development"

# For local dev, Wrangler will use a local SQLite database automatically
[[env.dev.d1_databases]]
binding = "DB"
database_name = "floatnative-db-dev"
database_id = "local"

[observability]
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = false
persist = true

[observability.traces]
enabled = false
persist = true
head_sampling_rate = 1

# Scheduled triggers
[triggers]
crons = ["0 * * * *"]  # Run every hour at minute 0

# Rate Limiting Configuration
# namespace_id must be unique positive integers for your account
# period must be either 10 or 60 seconds

# Health check endpoints - Very generous for monitoring systems
[[ratelimits]]
name = "HEALTH_CHECK_LIMITER"
namespace_id = "1001"
simple = { limit = 200, period = 60 }

# Authentication endpoints - Strict to prevent abuse
[[ratelimits]]
name = "AUTH_STRICT_LIMITER"
namespace_id = "1002"
simple = { limit = 20, period = 60 }

# QR code generation - Moderate to prevent session spam
[[ratelimits]]
name = "QR_GENERATE_LIMITER"
namespace_id = "1003"
simple = { limit = 30, period = 60 }

# QR polling - Generous as apps poll frequently while waiting
[[ratelimits]]
name = "QR_POLL_LIMITER"
namespace_id = "1004"
simple = { limit = 120, period = 60 }

# Playlist read operations - Generous for lightweight operations
[[ratelimits]]
name = "PLAYLIST_READ_LIMITER"
namespace_id = "1005"
simple = { limit = 100, period = 60 }

# Playlist write operations - Moderate for state changes
[[ratelimits]]
name = "PLAYLIST_WRITE_LIMITER"
namespace_id = "1006"
simple = { limit = 60, period = 60 }

# Search endpoint - Moderate to prevent abuse of public endpoint
[[ratelimits]]
name = "SEARCH_LIMITER"
namespace_id = "1007"
simple = { limit = 50, period = 60 }

# Public pages - Generous for static content
[[ratelimits]]
name = "PUBLIC_PAGE_LIMITER"
namespace_id = "1008"
simple = { limit = 100, period = 60 }